

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>FillPatch Iterator &mdash; amrex 18.01-dev documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="I/O (Plotfile, Checkpoint)" href="Chapter6a.html" />
    <link rel="prev" title="Amr Task" href="Chapter6aa.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> amrex
          

          
          </a>

          
            
            
              <div class="version">
                18.01-dev
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Introduction.html">AMReX Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="Chapter2.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="Chapter3.html">Building AMReX</a></li>
<li class="toctree-l1"><a class="reference internal" href="Chapter4.html">Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="Chapter4a.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="Chapter5.html">AmrCore Source Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="Chapter6.html">Amr Source Code</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="Chapter6aa.html">Amr Task</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">FillPatch Iterator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#regiongraph-iterator">RegionGraph Iterator</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Chapter6a.html">I/O (Plotfile, Checkpoint)</a></li>
<li class="toctree-l1"><a class="reference internal" href="Chapter7.html">Linear Solvers</a></li>
<li class="toctree-l1"><a class="reference internal" href="Chapter8.html">Particles</a></li>
<li class="toctree-l1"><a class="reference internal" href="Chapter9.html">Fortran Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="Chapter10.html">Embedded Boundaries</a></li>
<li class="toctree-l1"><a class="reference internal" href="ChapterGPU.html">GPU</a></li>
<li class="toctree-l1"><a class="reference internal" href="Chapter11.html">Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="Chapter12.html">AMReX-based Profiling Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="Chapter13.html">External Profiling Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="Chapter14.html">External Frameworks</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">amrex</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="Chapter6aa.html">Amr Task</a> &raquo;</li>
        
      <li>FillPatch Iterator</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/AsyncIter.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="fillpatch-iterator">
<h1>FillPatch Iterator<a class="headerlink" href="#fillpatch-iterator" title="Permalink to this headline">¶</a></h1>
<p>FillPatch is an important operation commonly used in AMReX applications.
This operation interpolates data in both space and time.
Communication between AMR levels may incur when FillPatch interpolates data from a coarse AMR level and stores the result on the next finer level.
This operation also results in communication within the same AMR level when the subcycling option is used, which requires data interpolation in time.</p>
<p>We develop an asynchronous version of the FillPatch operation, called Asynchronous FillPatch Iterator.
Each iterator takes care of the communication with the previous and next subcycles at the same AMR level (time) and between the current and the next finer AMR levels (space and time).
The iterator first automatically prepares temporary data needed for these communication activities and the data connections (aka data paths or data dependencies) among them.</p>
<p>Based on this setup, the programmer can design numerical solvers.
This work is fairly simple.
At a certain simulation time on an AMR level, the programmer can ask the runtime system which FABs have received sufficient data for advancing to the next time step.
Although the FillPatch operation can be handled independently by the communication handler of the runtime system, this operation requires some computations such as packing/unpacking and extrapolation.
The programmer has the freedom to dedicate a few threads from the pool of worker threads to parallelize those computations.
This design choice may help the runtime process FillPatch operations faster, but may slow down the main computation.
Thus, our advise to the programmer on using how many threads for the FillPatch is that it depends on the compute intensity of the actual workload.
If the simulation is memory-bandwidth or network-bandwidth bound, the programmer can get the benefit from sparing more threads for doing FillPatch.</p>
</div>
<div class="section" id="regiongraph-iterator">
<h1>RegionGraph Iterator<a class="headerlink" href="#regiongraph-iterator" title="Permalink to this headline">¶</a></h1>
<p>We can simplify the programming work further with a new abstraction called RegionGraph Iterator a.k.a RGIter.
This abstraction is a for loop (see the following code snippet), which can hide details of the asynchronous FillPatch Iterator in the init part and the graph traversal in the ++ operator.
The only job required from the programmer is to specify the computations on the data, and they can easily place these computations in the loop body.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="n">RGIter</span> <span class="n">rgi</span><span class="p">(</span><span class="n">afpi_vec</span><span class="p">,</span> <span class="n">upper_afpi_vec</span><span class="p">,</span> <span class="p">...);</span> <span class="n">rgi</span><span class="p">.</span><span class="n">isValid</span><span class="p">();</span> <span class="o">++</span><span class="n">rgi</span><span class="p">){</span>
    <span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="n">rgi</span><span class="p">.</span><span class="n">currentRegion</span><span class="p">;</span>
    <span class="p">...</span><span class="c1">//computation on FAB f</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The execution of RGIter is as follows.
Initially, an object of RGIter (i.e. rgi) is instantiated, taking vectors of FillPatch Iterators on the current and upper AMR levels as arguments (each element of the vector corresponds to a specific time).
Based on these arguments, a task dependency graph spanning two AMR levels will be established.
Next, isValid() asks the runtime system for FABs that have received all dependent data.
When there is such a FAB, the computations in the loop body can execute on the FAB’s data.
When the computations on a FAB finishes, the ++ operator is called.
We overload this operator to traverse to the next runnable FAB.</p>
<p>Note: RGIter also supports data tiling.
Specifically, we overload the ++ operator so that it will traverse data tiles in a FAB before it goes to next FAB if the tiling flag in the FAB is enabled.
Instead of applying the computations in the loop body on the entire FAB, it executes them on a single tile at a time.</p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Chapter6a.html" class="btn btn-neutral float-right" title="I/O (Plotfile, Checkpoint)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Chapter6aa.html" class="btn btn-neutral" title="Amr Task" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2018, AMReX Team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>